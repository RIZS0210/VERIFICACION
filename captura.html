<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Captura Facial Autom√°tica</title>
<style>
/* ... tus estilos se mantienen igual ... */
</style>
</head>
<body>

<h1>Coloca tu rostro dentro del c√≠rculo</h1>
<p id="instrucciones">Gira tu rostro lentamente para capturar varios √°ngulos autom√°ticamente.</p>

<div id="camara">
  <video autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
</div>

<div id="progressBar"><div id="progressFill"></div></div>
<div id="previewContainer"></div>
<p id="verificando">Verificando identidad...</p>
<p id="resultado"></p>

<script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>

<script>
const video = document.querySelector("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const verificandoMsg = document.getElementById("verificando");
const resultadoMsg = document.getElementById("resultado");
const progressFill = document.getElementById("progressFill");

let detectionComplete = false;
let pulse = 0;
let progressTotal = 0;
let capturas = [];

// --- Detectar si es m√≥vil ---
function esMovil() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

// --- Leer datos desde la URL ---
const urlParams = new URLSearchParams(window.location.search);
let dni = urlParams.get("dni");
let nombres = urlParams.get("nombres");
let apellidos = urlParams.get("apellidos");
let fotoReniecBase64 = null;

// Validaci√≥n inicial
if(!dni || !nombres || !apellidos){
  alert("‚ùå Datos incompletos, ser√° redirigido a la p√°gina inicial.");
  window.location.href = "index.html";
}

// Si no es m√≥vil, cancelar
if(!esMovil()){
  alert("‚ö†Ô∏è Esta verificaci√≥n solo puede hacerse desde un celular.");
  window.location.href = "index.html?status=error&mensaje=Debe%20usar%20un%20celular";
}

// --- Paso 1: Solicitud a RENIEC ---
async function solicitarDatosReniec(){
  try {
    const response = await fetch("https://verificacion-reniec.onrender.com/verificar", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ dni, nombres, apellidos })
    });

    const data = await response.json();

    if(data.status === "ok" && data.datos && data.datos.foto_base64){
      fotoReniecBase64 = data.datos.foto_base64;
      iniciarCamara();
    } else {
      alert("‚ùå No se pudo verificar en RENIEC: " + (data.mensaje || "Error desconocido"));
      window.location.href = "index.html?status=error&mensaje=" + encodeURIComponent("Error RENIEC");
    }

  } catch(err){
    console.error("Error en solicitud RENIEC:", err);
    alert("‚ùå Error de conexi√≥n con RENIEC");
    window.location.href = "index.html?status=error&mensaje=" + encodeURIComponent("Error de conexi√≥n con RENIEC");
  }
}

// --- Inicializar c√°mara ---
async function iniciarCamara() {
  try {
    await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');

    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;
    await video.play();

    overlay.width = video.videoWidth || 640;
    overlay.height = video.videoHeight || 480;

    detectLoop();
  } catch(err) {
    alert("‚ùå No se pudo acceder a la c√°mara. Revisa permisos y navegador HTTPS.");
    console.error(err);
  }
}

// --- El resto de tu l√≥gica (drawOverlay, detectarRostro, capturarFoto) se mantiene igual ---

// --- Enviar fotos al backend ---
async function enviarFotos(){
  try{
    const resp = await fetch("https://face-app-k1b5.onrender.com/verificar_foto", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        dni,
        fotos: capturas,
        foto_reniec: fotoReniecBase64
      })
    });

    const data = await resp.json();
    verificandoMsg.style.display='none';
    resultadoMsg.style.display='block';
    resultadoMsg.textContent = data.mensaje;
    resultadoMsg.className = data.status==="ok"?"ok":"error";

    // üîÑ Volver al index en 3s
    setTimeout(()=>{
      const query = new URLSearchParams({ dni, status: data.status, mensaje: data.mensaje });
      window.location.href = "index.html?" + query.toString();
    }, 3000);

  } catch(err){
    verificandoMsg.style.display='none';
    resultadoMsg.style.display='block';
    resultadoMsg.textContent="‚ùå Error de conexi√≥n";
    resultadoMsg.className="error";

    setTimeout(()=>{
      window.location.href = "index.html?dni=" + dni + "&status=error&mensaje=" + encodeURIComponent("Error de conexi√≥n");
    }, 3000);

    console.error(err);
  }
}

// --- Iniciar flujo ---
window.onload = solicitarDatosReniec;
</script>
</body>
</html>
