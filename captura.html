<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Captura Facial</title>
<style>
  body { text-align:center; font-family:Arial; padding:30px; background:#f4f6f9; }
  #camara { position: relative; display: inline-block; }
  video { width: 320px; border:2px solid #333; border-radius:8px; margin-top:20px; }
  #overlay {
    position: absolute;
    top: 0; left: 0;
    width: 320px; height: auto;
    border: 3px solid #0077cc;
    border-radius: 50%;
    box-sizing: border-box;
    pointer-events: none;
    margin-top:20px;
  }
  img.preview { width: 320px; margin-top:20px; border:2px solid #333; border-radius:8px; }
  button { padding: 10px 20px; font-size:16px; margin-top:15px; cursor:pointer; border:none; border-radius:8px; background:#0077cc; color:#fff; }
  button:hover { background:#005fa3; }
  #instrucciones { margin-top:20px; font-weight:bold; color:#444; }
</style>
</head>
<body>

<h1>Coloca tu rostro dentro del círculo</h1>
<p id="instrucciones">Gira tu cabeza lentamente mientras se captura la imagen.</p>

<div id="camara">
  <video autoplay></video>
  <div id="overlay"></div>
</div>
<br>
<button id="btnCapturar">Capturar rostro</button>
<div id="previewContainer"></div>

<script>
async function iniciarCamara() {
    try {
        const video = document.querySelector("video");
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        const btnCapturar = document.getElementById("btnCapturar");
        const previewContainer = document.getElementById("previewContainer");

        btnCapturar.onclick = async () => {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext("2d").drawImage(video, 0, 0);

            const fotoData = canvas.toDataURL("image/jpeg");

            // Previsualizar la foto
            previewContainer.innerHTML = "";
            const imgPreview = document.createElement("img");
            imgPreview.src = fotoData;
            imgPreview.className = "preview";
            previewContainer.appendChild(imgPreview);

            // Obtener DNI desde URL
            const params = new URLSearchParams(window.location.search);
            const dni = params.get("dni");
            if (!dni) {
                alert("No se encontró el DNI en la URL.");
                return;
            }

            // Enviar foto al backend
            const resp = await fetch("https://verificacion-reniec.onrender.com/verificar_foto", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ dni, foto: fotoData })
            });
            const resultado = await resp.json();

            alert(resultado.mensaje);
        };

    } catch (err) {
        alert("No se pudo acceder a la cámara: " + err);
    }
}

window.onload = iniciarCamara;
</script>

</body>
</html>
