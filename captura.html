<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Captura Facial Automática</title>
<style>
  body {
    margin:0;
    font-family: 'Segoe UI', Arial, sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    background: #e0f7fa;
    color:#333;
  }
  h1 { color:#0077cc; text-align:center; }
  #camara { position:relative; width:90%; max-width:400px; }
  video { display:none; }
  canvas { width:100%; height:100%; border-radius:12px; background:#f0f0f0; }
  #preview img { width:100%; max-width:400px; margin-top:10px; border:2px solid #0077cc; border-radius:12px; }
  #verificando, #resultado { font-size:1.5rem; font-weight:bold; text-align:center; margin-top:15px; display:none; }
  #resultado.ok { color: #00cc66; }
  #resultado.error { color: #cc3300; }
</style>
</head>
<body>

<h1>Coloca tu rostro dentro del círculo</h1>
<div id="camara">
  <video autoplay muted playsinline></video>
  <canvas id="overlay"></canvas>
</div>
<div id="preview"></div>
<p id="verificando">Verificando identidad...</p>
<p id="resultado"></p>

<script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script>
const video = document.querySelector("video");
const overlay = document.getElementById("overlay");
const ctx = overlay.getContext("2d");
const preview = document.getElementById("preview");
const verificandoMsg = document.getElementById("verificando");
const resultadoMsg = document.getElementById("resultado");

let detectionComplete = false;
let progressTotal = 0;

async function iniciarCamara() {
  await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
  await faceapi.nets.faceLandmark68TinyNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }});
  video.srcObject = stream;
  video.onloadedmetadata = () => {
    overlay.width = video.videoWidth;
    overlay.height = video.videoHeight;
    detectLoop();
  };
}

function drawOverlay(progress=0) {
  const cx = overlay.width/2;
  const cy = overlay.height/2;
  const radius = Math.min(overlay.width, overlay.height)/2.2;
  ctx.clearRect(0,0,overlay.width,overlay.height);

  ctx.save();
  ctx.beginPath();
  ctx.arc(cx, cy, radius, 0, 2*Math.PI);
  ctx.clip();
  ctx.drawImage(video,0,0,overlay.width,overlay.height);
  ctx.restore();

  // borde azul
  ctx.beginPath();
  ctx.arc(cx, cy, radius,0,2*Math.PI);
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#0077cc";
  ctx.stroke();

  if(progress>0){
    ctx.beginPath();
    ctx.arc(cx,cy,radius+5,-Math.PI/2,-Math.PI/2+2*Math.PI*progress);
    ctx.lineWidth=4;
    ctx.strokeStyle="#00cc66";
    ctx.stroke();
  }
}

async function detectLoop(){
  if(detectionComplete) return;
  const options = new faceapi.TinyFaceDetectorOptions({ inputSize:160, scoreThreshold:0.5 });
  const detections = await faceapi.detectSingleFace(video, options).withFaceLandmarks(true);

  if(detections){
    const nose = detections.landmarks.positions[30];
    const leftEye = detections.landmarks.positions[36];
    const rightEye = detections.landmarks.positions[45];
    const dx = nose.x - overlay.width/2;
    const dy = nose.y - overlay.height/2;
    const dist = Math.sqrt(dx*dx+dy*dy);
    const maxDist = 100;
    let frameProgress = Math.max(0,1-dist/maxDist);
    progressTotal = Math.min(1,progressTotal + frameProgress*0.02);
    drawOverlay(progressTotal);

    if(progressTotal>=0.95 && Math.abs(leftEye.x-rightEye.x)>40){
      detectionComplete=true;
      mostrarVerificando();
      await capturarFoto();
      return;
    }
  } else {
    drawOverlay(progressTotal);
  }

  requestAnimationFrame(detectLoop);
}

function mostrarVerificando(){
  document.getElementById("camara").style.display="none";
  verificandoMsg.style.display="block";
}

async function capturarFoto(){
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const fotoData = canvas.toDataURL("image/jpeg");

  // mostrar previsualización
  const img = document.createElement("img");
  img.src = fotoData;
  preview.appendChild(img);

  const params = new URLSearchParams(window.location.search);
  const dni = params.get("dni") || "00000000"; // dni por defecto si no viene

  try{
    const resp = await fetch("http://127.0.0.1:5000/verificar_foto", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({dni,foto:fotoData})
    });
    const data = await resp.json();
    verificandoMsg.style.display="none";
    resultadoMsg.style.display="block";

    if(data.mensaje.includes("coinciden")){
      resultadoMsg.textContent="✅ Verificación exitosa";
      resultadoMsg.className="ok";
    } else {
      resultadoMsg.textContent="❌ Verificación fallida";
      resultadoMsg.className="error";
    }

  }catch(e){
    verificandoMsg.style.display="none";
    resultadoMsg.style.display="block";
    resultadoMsg.textContent="❌ Error de conexión al servidor";
    resultadoMsg.className="error";
    console.error(e);
  }
}

window.onload=iniciarCamara;
</script>
</body>
</html>
