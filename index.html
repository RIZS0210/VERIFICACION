<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verificación Facial</title>
<style>
body {
  font-family: Arial, sans-serif;
  text-align: center;
  background-color: #f4f6f9;
  margin: 0;
  padding: 20px;
}
h1 { color: #333; }
#mensaje { margin: 15px 0; font-weight: bold; color: #444; white-space: pre-line; }
video { border-radius: 8px; border: 2px solid #333; }
#overlay {
  position: absolute;
  border: 2px dashed #0077cc;
  border-radius: 50%;
  width: 250px;
  height: 250px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}
#camara-container { position: relative; display: inline-block; }
button {
  padding: 15px 30px;
  font-size: 16px;
  font-weight: bold;
  color: #fff;
  background-color: #0077cc;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 20px;
}
button:hover { background-color: #005fa3; }
</style>
</head>
<body>

<h1>Verificación Facial</h1>
<p id="mensaje">Coloca tu rostro dentro del círculo y muévete lentamente.</p>

<div id="camara-container">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
</div>

<br>
<button id="capturar">Capturar Rostro</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
const dni = urlParams.get("dni");  // Se pasa DNI por QR

if(!dni){
  alert("No se recibió DNI. Regresa a la página principal.");
  window.location.href = "/";
}

const video = document.getElementById("video");
const btnCapturar = document.getElementById("capturar");

async function iniciarCamara() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  } catch (err) {
    alert("No se pudo acceder a la cámara: " + err);
  }
}

async function resizeImage(base64Str, maxWidth = 300, maxHeight = 300) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let { width, height } = img;
      const scale = Math.min(maxWidth/width, maxHeight/height, 1);
      width *= scale; height *= scale;
      const canvas = document.createElement("canvas");
      canvas.width = width; canvas.height = height;
      canvas.getContext("2d").drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL("image/jpeg"));
    };
    img.src = base64Str;
  });
}

btnCapturar.onclick = async () => {
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video, 0, 0);
  let fotoData = canvas.toDataURL("image/jpeg");
  let fotoResized = await resizeImage(fotoData, 300, 300);

  // Enviar al backend
  const resp = await fetch("https://verificacion-reniec.onrender.com/verificar_foto", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ dni, foto: fotoResized })
  });
  const resultado = await resp.json();
  document.getElementById("mensaje").textContent = resultado.mensaje;

  if(resultado.status === "ok") {
    alert("✅ Verificación facial completada con éxito.");
  } else {
    alert("❌ Rostro no coincide. Intenta nuevamente.");
  }
}

iniciarCamara();
</script>
</body>
</html>
